<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-good {
            color: #22c55e;
            font-weight: bold;
        }

        .status-error {
            color: #ef4444;
            font-weight: bold;
        }

        .status-warning {
            color: #f59e0b;
            font-weight: bold;
        }

        button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }

        button:hover {
            background: #2563eb;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        button.success {
            background: #22c55e;
        }

        button.success:hover {
            background: #16a34a;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover {
            background: #dc2626;
        }

        #output {
            min-height: 300px;
            border: 1px solid #d1d5db;
            padding: 15px;
            background: #f9fafb;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
        }

        .order-card {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            background: #f8fafc;
        }

        .order-pending {
            border-left: 4px solid #f59e0b;
        }

        .order-confirmed {
            border-left: 4px solid #22c55e;
        }

        .order-rejected {
            border-left: 4px solid #ef4444;
        }
    </style>
</head>

<body>
    <h1>🧪 Order Management Testing Tool</h1>
    <p>This tool tests the order approval and rejection functionality with the latest fixes.</p>

    <div class="test-section">
        <h2>1. Authentication Status</h2>
        <p>User: <span id="user-status">Checking...</span></p>
        <p>Access Token: <span id="token-status">Checking...</span></p>
        <p>User Role: <span id="role-status">Checking...</span></p>
        <button onclick="checkAuth()">Refresh Auth Status</button>
        <button onclick="loginAsWarehouse()" class="success">Quick Login (Warehouse)</button>
    </div>

    <div class="test-section">
        <h2>2. Order Management Tests</h2>
        <button onclick="loadOrders()">Load Orders</button>
        <button onclick="findPendingOrders()">Find Pending Orders</button>
        <button onclick="testApprovalWorkflow()" id="test-approval-btn" disabled>Test Approval</button>
        <button onclick="testRejectionWorkflow()" class="danger" id="test-rejection-btn" disabled>Test
            Rejection</button>
    </div>

    <div class="test-section">
        <h2>3. Orders Status</h2>
        <div id="orders-list">No orders loaded yet...</div>
    </div>

    <div class="test-section">
        <h2>4. Debug Output</h2>
        <div id="output">Ready for testing...\n</div>
        <button onclick="clearOutput()">Clear Output</button>
        <button onclick="openOrderManagement()">Open Order Management</button>
    </div>

    <script>
        let currentOrders = [];
        let pendingOrders = [];
        let currentUser = null;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').textContent = 'Cleared...\n';
        }

        async function checkAuth() {
            log('Checking authentication status...');

            const accessToken = localStorage.getItem('accessToken');
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');

            const tokenStatus = document.getElementById('token-status');
            tokenStatus.textContent = accessToken ? 'Present' : 'Missing';
            tokenStatus.className = accessToken ? 'status-good' : 'status-error';

            if (userStr) {
                try {
                    currentUser = JSON.parse(userStr);
                    document.getElementById('user-status').textContent = `${currentUser.fullName} (${currentUser.email})`;
                    document.getElementById('user-status').className = 'status-good';
                    document.getElementById('role-status').textContent = currentUser.role;

                    const canApprove = ['admin', 'warehouse', 'cashier'].includes(currentUser.role);
                    document.getElementById('role-status').className = canApprove ? 'status-good' : 'status-warning';

                    log(`✅ User: ${currentUser.fullName} - Role: ${currentUser.role} - Can Approve: ${canApprove}`, 'success');

                    if (!canApprove) {
                        log('⚠️ Current user cannot approve orders. Need admin/warehouse/cashier role.', 'warning');
                    }
                } catch (e) {
                    log('❌ Error parsing user data', 'error');
                }
            } else {
                document.getElementById('user-status').textContent = 'Not logged in';
                document.getElementById('user-status').className = 'status-error';
                log('❌ No user data found - need to login', 'error');
            }

            if (!accessToken && !token) {
                log('❌ No authentication tokens found', 'error');
                return false;
            }

            log('✅ Authentication tokens found', 'success');
            return true;
        }

        async function loginAsWarehouse() {
            log('Logging in as warehouse user...');

            try {
                const response = await fetch('http://localhost:5001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'house1@gmail.com',
                        password: '123456'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('token', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    log('✅ Warehouse login successful', 'success');
                    await checkAuth();
                } else {
                    log(`❌ Login failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`❌ Login error: ${error.message}`, 'error');
            }
        }

        async function loadOrders() {
            log('Loading orders from API...');

            const authToken = localStorage.getItem('accessToken') || localStorage.getItem('token');
            if (!authToken) {
                log('❌ No auth token available', 'error');
                return;
            }

            try {
                const response = await fetch('http://localhost:5001/api/orders?limit=50', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                log(`API Response Status: ${response.status}`);
                const data = await response.json();

                if (data.success) {
                    currentOrders = data.data || [];
                    log(`✅ Loaded ${currentOrders.length} orders`, 'success');
                    displayOrders();
                } else {
                    log(`❌ API Error: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`❌ Network Error: ${error.message}`, 'error');
            }
        }

        function displayOrders() {
            const ordersList = document.getElementById('orders-list');

            if (currentOrders.length === 0) {
                ordersList.innerHTML = 'No orders found.';
                return;
            }

            const ordersHtml = currentOrders.map(order => {
                const statusClass = order.status === 'Pending Approval' ? 'order-pending' :
                    order.status === 'Confirmed' ? 'order-confirmed' :
                        order.status === 'Rejected' ? 'order-rejected' : '';

                return `
                    <div class="order-card ${statusClass}">
                        <strong>${order.orderNumber || order._id}</strong> -
                        Status: <strong>${order.status}</strong><br>
                        Customer: ${order.customer?.fullName || order.customer}<br>
                        Items: ${order.items?.length || 0} item(s)<br>
                        Amount: LKR ${(order.finalAmount || order.totalAmount || 0).toLocaleString()}
                    </div>
                `;
            }).join('');

            ordersList.innerHTML = ordersHtml;
        }

        async function findPendingOrders() {
            log('Finding pending approval orders...');

            if (currentOrders.length === 0) {
                log('⚠️ No orders loaded - run "Load Orders" first', 'warning');
                return;
            }

            pendingOrders = currentOrders.filter(order => order.status === 'Pending Approval');
            log(`Found ${pendingOrders.length} pending approval orders`);

            if (pendingOrders.length > 0) {
                pendingOrders.forEach((order, index) => {
                    log(`  ${index + 1}. ${order.orderNumber || order._id} - Customer: ${order.customer?.fullName || order.customer}`);
                });

                document.getElementById('test-approval-btn').disabled = false;
                document.getElementById('test-rejection-btn').disabled = false;
                log('✅ Ready to test approval/rejection', 'success');
            } else {
                log('⚠️ No pending orders to test with', 'warning');
            }
        }

        async function testApprovalWorkflow() {
            if (pendingOrders.length === 0) {
                log('❌ No pending orders available for testing', 'error');
                return;
            }

            const testOrder = pendingOrders[0];
            log(`Testing approval for order: ${testOrder.orderNumber || testOrder._id}`);

            const authToken = localStorage.getItem('accessToken') || localStorage.getItem('token');

            try {
                log(`Making PATCH request to: /api/orders/${testOrder._id}/approve`);

                const response = await fetch(`http://localhost:5001/api/orders/${testOrder._id}/approve`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ notes: 'Test approval from testing tool' })
                });

                log(`Response Status: ${response.status}`);
                const result = await response.json();
                log(`Response Data: ${JSON.stringify(result, null, 2)}`);

                if (response.ok && result.success) {
                    log(`🎉 ORDER APPROVAL SUCCESSFUL!`, 'success');
                    log(`Order ${testOrder.orderNumber || testOrder._id} is now ${result.data?.status || 'CONFIRMED'}`, 'success');
                    await loadOrders(); // Refresh
                    await findPendingOrders();
                } else {
                    log(`❌ Approval failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`❌ Approval error: ${error.message}`, 'error');
            }
        }

        async function testRejectionWorkflow() {
            if (pendingOrders.length === 0) {
                log('❌ No pending orders available for testing', 'error');
                return;
            }

            const testOrder = pendingOrders[0];
            log(`Testing rejection for order: ${testOrder.orderNumber || testOrder._id}`);

            const authToken = localStorage.getItem('accessToken') || localStorage.getItem('token');
            const rejectionReason = 'Test rejection from testing tool - insufficient inventory';

            try {
                log(`Making PATCH request to: /api/orders/${testOrder._id}/reject`);

                const response = await fetch(`http://localhost:5001/api/orders/${testOrder._id}/reject`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ reason: rejectionReason })
                });

                log(`Response Status: ${response.status}`);
                const result = await response.json();
                log(`Response Data: ${JSON.stringify(result, null, 2)}`);

                if (response.ok && result.success) {
                    log(`🎉 ORDER REJECTION SUCCESSFUL!`, 'success');
                    log(`Order ${testOrder.orderNumber || testOrder._id} is now ${result.data?.status || 'REJECTED'}`, 'success');
                    await loadOrders(); // Refresh
                    await findPendingOrders();
                } else {
                    log(`❌ Rejection failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`❌ Rejection error: ${error.message}`, 'error');
            }
        }

        function openOrderManagement() {
            window.open('/orders', '_blank');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
    </script>
</body>

</html>
